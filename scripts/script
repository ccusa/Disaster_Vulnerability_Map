library(dplyr)
library(magrittr)
library(rgdal)
library(stringr)

# CDC data. Available at https://svi.cdc.gov/SVIDataToolsDownload.html
# replace /Users/jakesnyder/DisasterVulnerability/ with the path to the data on your machine
cdc_data <- readOGR(dsn = "/Users/jakesnyder/DisasterVulnerability/County", layer = "counties", stringsAsFactors = F)

# Disaster likelyhood by fips. Available if you have accest to proprietary data
# replace /Users/jakesnyder/DisasterVulnerability/ with the path to the data on your machine
hazard_data <- read.csv("/Users/jakesnyder/DisasterVulnerability/ATTOM hazard.csv",stringsAsFactors = F, colClasses = c("FIPS" = "character"))

# remove NA's from hazard data
hazard_data <- na.omit(hazard_data)

# Load CCUSA agency and remove extra columns
ccusa <- read.csv("/Users/jakesnyder/DisasterVulnerability/Poly_counties.csv",stringsAsFactors = F)
ccusa <- ccusa %>% select(FIPS,Diocese) %>%
  mutate(FIPS = str_pad(FIPS,5,pad="0"))

# join hazard data to shapefile
merge_data <- merge(cdc_data, hazard_data, by.x="FIPS", by.y="FIPS", all.x=T)
merge_data <- merge(merge_data, ccusa, by = "FIPS", all.x=T)

# getting data as data frame
county <- merge_data@data
# removing columns we don't need to keep the shapefile smaller
county <- county %>% select(F_TOTAL,
                            starts_with('F_THEME'),
                            starts_with('EP'),
                            starts_with('RP'),
                            contains('Risk'),
                            Diocese) %>%
  # set null values created by join to 0
  mutate(Total.Natural.Hazard.Risk.Index = ifelse(is.na(Total.Natural.Hazard.Risk.Index),0,Total.Natural.Hazard.Risk.Index)) %>%
  mutate(Earthquake.Risk.Index = ifelse(is.na(Earthquake.Risk.Index),0,Earthquake.Risk.Index)) %>%
  mutate(Tornado.Risk.Index = ifelse(is.na(Tornado.Risk.Index),0,Tornado.Risk.Index)) %>%
  mutate(Hail.Risk.Index = ifelse(is.na(Hail.Risk.Index),0,Hail.Risk.Index)) %>%
  mutate(Hurricane.Storm.Surge.Risk.Index = ifelse(is.na(Hurricane.Storm.Surge.Risk.Index),0,Hurricane.Storm.Surge.Risk.Index)) %>%
  mutate(Flood.Risk.Index = ifelse(is.na(Flood.Risk.Index),0,Flood.Risk.Index)) %>%
  mutate(Wildfire.Risk.Index = ifelse(is.na(Wildfire.Risk.Index),0,Wildfire.Risk.Index))

# setting it back to a large SpatialPolygonsDataframe
merge_data@data <- county

# replace /Users/jakesnyder/DisasterVulnerability/ with the path to your desired directory
writeOGR(merge_data, dsn="/Users/jakesnyder/DisasterVulnerability", layer="counties", driver="ESRI Shapefile", overwrite_layer = T)

## tract file reduction
svi <- readOGR("/Users/jakesnyder/DisasterVulnerability/Tract", stringsAsFactors = F)
tract <- svi@data

# removing columns we don't need to keep the shapefile smaller
tract <- tract %>% select(F_TOTAL,
                          starts_with('F_THEME'),
                          starts_with('EP'),
                          starts_with('RP'))
# change null values to zero
tract[tract==-999] <- 0

svi@data <- tract
# replace /Users/jakesnyder/DisasterVulnerability/ with the path to your desired directory
writeOGR(svi, dsn="/Users/jakesnyder/DisasterVulnerability", layer="tracts", driver="ESRI Shapefile", overwrite_layer = T)
